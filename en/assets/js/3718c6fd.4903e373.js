"use strict";(self.webpackChunknapi_www=self.webpackChunknapi_www||[]).push([[2571],{93026:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var t=r(74848),a=r(28453);const i={slug:"modbus-sniffer-python",title:"Python-\u0441\u043d\u0438\u0444\u0444\u0435\u0440 \u0434\u043b\u044f \u0430\u043d\u0430\u043b\u0438\u0437\u0430 Modbus RTU \u0442\u0440\u0430\u0444\u0438\u043a\u0430",authors:"dmn",tags:["modbus","python","sniffer","debugging","serial"],telegram_id:11},s=void 0,o={permalink:"/en/recipes/modbus-sniffer-python",source:"@site/techblog/2025-08-08-modbus-sniffer-python/index.md",title:"Python-\u0441\u043d\u0438\u0444\u0444\u0435\u0440 \u0434\u043b\u044f \u0430\u043d\u0430\u043b\u0438\u0437\u0430 Modbus RTU \u0442\u0440\u0430\u0444\u0438\u043a\u0430",description:'\u041d\u0430\u043f\u0438\u0441\u0430\u043b "\u043d\u0430 \u043a\u043e\u043b\u0435\u043d\u043a\u0435" \u043f\u043e\u043b\u0435\u0437\u043d\u044b\u0439 \u0441\u043d\u0438\u0444\u0444\u0435\u0440 modbus',date:"2025-08-08T00:00:00.000Z",tags:[{inline:!0,label:"modbus",permalink:"/en/recipes/tags/modbus"},{inline:!0,label:"python",permalink:"/en/recipes/tags/python"},{inline:!0,label:"sniffer",permalink:"/en/recipes/tags/sniffer"},{inline:!0,label:"debugging",permalink:"/en/recipes/tags/debugging"},{inline:!0,label:"serial",permalink:"/en/recipes/tags/serial"}],readingTime:2.01,hasTruncateMarker:!1,authors:[{name:"dmn",title:"maintainer",url:"https://github.com/dmnovikov",imageURL:"https://avatars.githubusercontent.com/u/17533288?v=4",key:"dmn"}],frontMatter:{slug:"modbus-sniffer-python",title:"Python-\u0441\u043d\u0438\u0444\u0444\u0435\u0440 \u0434\u043b\u044f \u0430\u043d\u0430\u043b\u0438\u0437\u0430 Modbus RTU \u0442\u0440\u0430\u0444\u0438\u043a\u0430",authors:"dmn",tags:["modbus","python","sniffer","debugging","serial"],telegram_id:11},unlisted:!1,prevItem:{title:"\u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f UART \u043d\u0430 \u043c\u043e\u0434\u0443\u043b\u0435 CM4 \u0432 \u0422\u043e\u043a\u043e\u0441\u0431\u043e\u0440\u0449\u0438\u043a\u0435",permalink:"/en/recipes/cm4-uart-configuration"},nextItem:{title:"\u0410\u0434\u0440\u0435\u0441\u0430\u0446\u0438\u044f GPIO \u0432 gpiod \u043d\u0430 \u043f\u0440\u0438\u043c\u0435\u0440\u0435 GPIO2_B4",permalink:"/en/recipes/gpio-gpiod-addressing"}},d={authorsImageUrls:[void 0]},l=[];function c(e){const n={code:"code",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:'\u041d\u0430\u043f\u0438\u0441\u0430\u043b "\u043d\u0430 \u043a\u043e\u043b\u0435\u043d\u043a\u0435" \u043f\u043e\u043b\u0435\u0437\u043d\u044b\u0439 \u0441\u043d\u0438\u0444\u0444\u0435\u0440 modbus'}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"modbus_sniffer_raw_pretty.py"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'#!/usr/bin/env python3\n"""\nRaw Modbus RTU Sniffer \u2014 listens to a serial port and prints decoded Modbus RTU frames.\nNow includes decoding of address/count/value for popular function codes.\n"""\n\nimport serial\nimport argparse\nimport time\nimport logging\nimport struct\n\nlogging.basicConfig()\nlog = logging.getLogger()\nlog.setLevel(logging.INFO)\n\ndef calculate_crc(data: bytes):\n    crc = 0xFFFF\n    for pos in data:\n        crc ^= pos\n        for _ in range(8):\n            lsb = crc & 0x0001\n            crc >>= 1\n            if lsb:\n                crc ^= 0xA001\n    return crc.to_bytes(2, \'little\')\n\ndef validate_crc(frame: bytes):\n    if len(frame) < 4:\n        return False\n    data, received_crc = frame[:-2], frame[-2:]\n    return calculate_crc(data) == received_crc\n\ndef decode_payload(fc, payload):\n    if fc in [1, 2, 3, 4]:  # Read coils, discrete inputs, HR, IR\n        if len(payload) >= 4:\n            address, count = struct.unpack(">HH", payload[:4])\n            return f"Read | Addr={address} | Count={count}"\n    elif fc in [5, 6]:  # Write single coil/register\n        if len(payload) >= 4:\n            address, value = struct.unpack(">HH", payload[:4])\n            return f"Write Single | Addr={address} | Value={value}"\n    elif fc in [15, 16]:  # Write multiple coils/registers\n        if len(payload) >= 5:\n            address, count, byte_count = struct.unpack(">HHB", payload[:5])\n            return f"Write Multiple | Addr={address} | Count={count} | Bytes={byte_count}"\n    return f"Payload: {payload.hex()}"\n\ndef print_frame_info(frame: bytes):\n    if not validate_crc(frame):\n        log.warning(f"\u274c Invalid CRC: {frame.hex()}")\n        return\n    unit_id = frame[0]\n    function_code = frame[1]\n    payload = frame[2:-2]\n    desc = decode_payload(function_code, payload)\n    log.info(f"\ud83d\udce5 Unit={unit_id} | FC={function_code} \u2014 {desc}")\n\ndef read_frames(ser):\n    buffer = bytearray()\n    last_byte_time = time.time()\n    inter_char_timeout = 0.01\n    frame_timeout = 0.1\n\n    while True:\n        if ser.in_waiting:\n            byte = ser.read(1)\n            now = time.time()\n            if now - last_byte_time > frame_timeout and buffer:\n                print_frame_info(bytes(buffer))\n                buffer.clear()\n            buffer.append(byte[0])\n            last_byte_time = now\n        elif buffer and time.time() - last_byte_time > frame_timeout:\n            print_frame_info(bytes(buffer))\n            buffer.clear()\n        else:\n            time.sleep(0.005)\n\ndef main():\n    parser = argparse.ArgumentParser(description="Raw Modbus RTU Sniffer with decoding")\n    parser.add_argument(\'--port\', required=True, help=\'Serial port (e.g. /dev/ttyUSB0)\')\n    parser.add_argument(\'--baudrate\', type=int, default=9600)\n    parser.add_argument(\'--parity\', choices=[\'N\', \'E\', \'O\'], default=\'N\')\n    parser.add_argument(\'--stopbits\', type=int, choices=[1, 2], default=1)\n    args = parser.parse_args()\n\n    try:\n        ser = serial.Serial(\n            port=args.port,\n            baudrate=args.baudrate,\n            parity={\'N\': serial.PARITY_NONE, \'E\': serial.PARITY_EVEN, \'O\': serial.PARITY_ODD}[args.parity],\n            stopbits=args.stopbits,\n            bytesize=8,\n            timeout=0\n        )\n        log.info(f"\ud83d\udd0d Listening on {args.port} at {args.baudrate} bps...")\n        read_frames(ser)\n    except Exception as e:\n        log.error(f"Failed to open serial port: {e}")\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 \u0431\u0438\u0431\u043b\u0438\u043e\u0442\u0435\u043a\u0443 pyserial"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"pip install pyserial\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u041f\u0440\u0438\u043c\u0435\u0440:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"(venv) orangepi@cm4-right:~$ python3 modbus_sniffer_raw_pretty.py  --baudrate 9600 --port /dev/ttyS9\nINFO:root:\ud83d\udd0d Listening on /dev/ttyS9 at 9600 bps...\nINFO:root:\ud83d\udce5 Unit=1 | FC=3 \u2014 Read | Addr=0 | Count=1\nINFO:root:\ud83d\udce5 Unit=1 | FC=3 \u2014 Read | Addr=10 | Count=2\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u0421\u043a\u0440\u0438\u043f\u0442 \u0447\u0438\u0442\u0430\u0435\u0442 \u0438  \u0440\u0430\u0441\u043f\u043e\u0437\u043d\u0430\u0435\u0442 \u043f\u0430\u043a\u0435\u0442\u044b modbus, \u0437\u0430\u043f\u0440\u043e\u0441\u044b modbus \u0442\u0440\u0430\u043d\u0441\u043b\u0438\u0440\u0443\u0435\u0442 \u043d\u0430 \u044d\u043a\u0440\u0430\u043d."}),"\n",(0,t.jsx)(n.p,{children:"#modbus #modbussniffer"})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>o});var t=r(96540);const a={},i=t.createContext(a);function s(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);