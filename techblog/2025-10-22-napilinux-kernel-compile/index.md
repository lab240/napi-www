---
slug: napilinux-kernel-compile
title: –ö–æ–º–ø–∏–ª—è—Ü–∏—è —è–¥—Ä–∞ NapiLinux - –±—ã—Å—Ç—Ä—ã–π –º–µ—Ç–æ–¥
authors: dmn
tags: [napilinux, kernel, compilation, cross-compile, overlay]
telegram_id: 23
---

üî• –ë—ã—Å—Ç—Ä—ã–π –º–µ—Ç–æ–¥ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —è–¥—Ä–∞ NapiLinux –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã.

## –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

‚òùÔ∏è –≠—Ç–æ "–≥—Ä—è–∑–Ω—ã–π" –±—ã—Å—Ç—Ä—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —è–¥—Ä–∞.  
üí° **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±** - –∫–æ–º–ø–∏–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ Yocto.

## 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é –≤–µ—Ç–∫—É –¥–ª—è –≤–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ç–∫–∏:**
- ‚úîÔ∏è `rk-6.1` - –¥–ª—è RK3308
- ‚úîÔ∏è `orange-pi-6.6` - –¥–ª—è Orange Pi  
- ‚úîÔ∏è `rk35xx` - –¥–ª—è RK35xx
- –ò –¥—Ä—É–≥–∏–µ (—Å–º. GitLab)

```bash
git clone https://gitlab.nnz-ipc.net/pub/napilinux/kernel.git --branch=rk-6.1 --depth=1
cd kernel/
```

## 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è ARM64

```bash
export ARCH=arm64
export CROSS_COMPILE=aarch64-linux-gnu-
```

## 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ö–æ–Ω—Ñ–∏–≥–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ `/arch/arm64/configs`. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π:

**–î–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ NAPI:**
```bash
make napi_defconfig
```

**–î–ª—è CM4:**
```bash
make opi_cm4_defconfig
```

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Ñ–∞–π–ª `.config`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã.

## 4. –ö–æ–º–ø–∏–ª—è—Ü–∏—è —è–¥—Ä–∞

```bash
make -j10
```

–ì–¥–µ `10` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–ø–æ–¥–±–µ—Ä–∏—Ç–µ –ø–æ–¥ —Å–≤–æ—é —Å–∏—Å—Ç–µ–º—É).

## 5. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∫–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –ø–æ–ª—É—á–∏—Ç–µ:

- ‚úîÔ∏è **–û–±—Ä–∞–∑ —è–¥—Ä–∞**: `arch/arm64/boot/Image`
- ‚úîÔ∏è **–ì–ª–∞–≤–Ω–∞—è DTB**: `arch/arm64/boot/<—Ñ–∞–π–ª>.dtb`  
- ‚úîÔ∏è **–û–≤–µ—Ä–ª–µ–∏**: `arch/arm64/boot/dts/rockchip/`

## 6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ —Å–∏—Å—Ç–µ–º—É

### –í–∞–∂–Ω–æ –ø—Ä–æ overlay root!

NapiLinux –∏—Å–ø–æ–ª—å–∑—É–µ—Ç root (/) –∫–∞–∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø–∞—Ä—Ç–∏—Ü–∏—é overlay. –ü—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è - u-boot –∏—Ö –Ω–µ —É–≤–∏–¥–∏—Ç!

### –†–µ—à–µ–Ω–∏—è:

**–†–∞–±–æ—Ç–∞ —Å SD-–∫–∞—Ä—Ç–æ–π:**
```bash
# –ò–∑–≤–ª–µ–∫–∏—Ç–µ SD-–∫–∞—Ä—Ç—É
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫ –∫–æ–º–ø—å—é—Ç–µ—Ä—É
# –ü—Ä–∏–º–æ–Ω—Ç–∏—Ä—É–π—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
sudo mount /dev/sdX1 /mnt/boot
sudo cp arch/arm64/boot/Image /mnt/boot/
sudo cp arch/arm64/boot/dts/rockchip/*.dtb /mnt/boot/
sudo umount /mnt/boot
```

**–†–∞–±–æ—Ç–∞ —Å NAND/eMMC:**
```bash
# –ó–∞–≥—Ä—É–∑–∏—Ç–µ—Å—å —Å SD-–∫–∞—Ä—Ç—ã  
# –ü—Ä–∏–º–æ–Ω—Ç–∏—Ä—É–π—Ç–µ —Ü–µ–ª–µ–≤—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é
lsblk -f  # –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
sudo mount /dev/mmcblk0p1 /mnt/boot
sudo cp arch/arm64/boot/Image /mnt/boot/
sudo cp arch/arm64/boot/dts/rockchip/*.dtb /mnt/boot/
sudo umount /mnt/boot
```

## 7. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–∞—Ä—Ç–∏—Ü–∏–π

–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞—Ä—Ç–∏—Ü–∏–π:

```bash
lsblk
lsblk -f
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–∞:
```bash
# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é
make menuconfig

# –¢–µ–∫—Å—Ç–æ–≤–æ–µ –º–µ–Ω—é  
make nconfig
```

### –°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ DTB:
```bash
make dtbs
```

### –°–±–æ—Ä–∫–∞ –º–æ–¥—É–ª–µ–π:
```bash
make modules
make modules_install INSTALL_MOD_PATH=/path/to/rootfs
```

## –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞:
```bash
${CROSS_COMPILE}gcc --version
```

### –û—á–∏—Å—Ç–∫–∞ —Å–±–æ—Ä–∫–∏:
```bash
make clean
make mrproper
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞:
```bash
make ARCH=arm64 listnewconfig
```

–î–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–¥—Ä–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞ —á–µ—Ä–µ–∑ Yocto.