---
slug: napilinux-kernel-compile
title: Компиляция ядра NapiLinux - быстрый метод
authors: dmn
tags: [napilinux, kernel, compilation, cross-compile, overlay]
telegram_id: 23
---

## Как скомпилировать только ядро NapiLinux

Это "грязный" быстрый метод, который позволяет не компилировать всю систему, а быстро включить какие-то опции ядра и проверить новое ядро в системе.

**Правильный способ компиляции NapiLinux** — через пакет Yocto. 
 
### 1. Сделать клон ядра с нужной ветки (branch)

Бранч — это версия репозитория ядра. Для разных платформ она разная, и нужно выбрать ту, которая вас интересует:

- `rk-6.1`
- `orange-pi-6.6`
- `rk35xx`

и т. п. (выбирайте на сайте GitLab) 
 
```bash
git clone https://gitlab.nnz-ipc.net/pub/napilinux/kernel.git --branch=rk-6.1 --depth=1
cd kernel/
``` 
 
### 2. Настроить переменные для архитектуры (ARM64) 

```bash
export ARCH=arm64
export CROSS_COMPILE=aarch64-linux-gnu-
``` 
### 3. Подготовить конфиг

- Конфиги лежат в папке `/arch/arm64/configs`
- В каждой ветке нужно выбрать свой конфиг:

**Для Napi:**
```bash
make napi_defconfig
```

**Для CM4:**
```bash
make opi_cm4_defconfig
``` 
 
### 4. Настройка конфигурации

После этого появится файл `.config`, в котором вы можете изменить опции ядра под себя.

### 5. Запускаем компиляцию ядра 

```bash
make -j10
``` 
### 6. Результаты сборки

- **Имидж ядра** — `arch/arm64/boot/Image`
- **Главная DTB** (дерево устройств) — `arch/arm64/boot/<файл>.dtb`
- **Оверлеи** — `arch/arm64/boot/dts/rockchip/` 
 
### 7. Замена ядра в системе

Теперь можно заменить файлы `Image` и `.dtb` в `/boot`, затем перезагрузить систему.

### 8. Важно про overlay root! 

NapiLinux использует root (`/`) как виртуальную партицию overlay, поэтому просто переписать ядро и другие файлы из системы не получится (на деле вы запишете их в overlay, и u-boot их не увидит).

### Что делать?

- **Если работаете на SD-карте** — выньте SD, примонтируйте обе физические партиции и запишите новые файлы в их `/boot`

- **Если работаете с NAND/eMMC** — загрузитесь с SD, примонтируйте обе партиции и запишите туда файлы вручную 
 
### Просмотр структуры партиций

Посмотреть структуру партиций можно командами: 

```bash
lsblk
lsblk -f
``` 
#napilinux #napikernel