---
slug: modbus-signal-analysis
title: Анализ сигналов Modbus RS485 на анализаторе
authors: dmn
tags: [modbus, rs485, signal-analysis, rts, logic-analyzer]
telegram_id: 35
---

Демонстрация передачи Modbus пакетов на цифровом анализаторе сигналов между NAPI-C (хост) и учебным Modbus датчиком.

## Схема подключения анализатора

**Конфигурация каналов:**
1. **Канал 1** - RTS хоста (управление направлением)
2. **Канал 2** - RX хоста (прием данных) 
3. **Канал 3** - TX хоста (передача данных)
4. **Канал 4** - RX датчика (прием на датчике)
5. **Канал 5** - TX датчика (передача с датчика)

## Последовательность работы RS485

### Фаза запроса:
1. **Хост поднимает RTS** - переводит шину в режим передачи
2. **Хост передает запрос** - данные идут по TX хоста → RX датчика  
3. **Хост опускает RTS** - переводит шину в режим приема

### Фаза ответа:
4. **Датчик передает ответ** - данные идут по TX датчика → RX хоста
5. **Хост принимает ответ** - обрабатывает полученные данные

## Настройка хоста (NAPI-C)

### Конфигурация UART с программным RTS:
```bash
stty -F /dev/ttyS1 9600 cs8 -cstopb -parenb -ixon -ixoff -crtscts
```

### Overlay для RS485 с GPIO RTS:
```dts
/dts-v1/;
/plugin/;

/ {
  compatible = "rockchip,rk3308";
  
  fragment@0 {
    target = <&uart1>;
    __overlay__ {
      status = "okay";
      linux,rs485-enabled-at-boot-time;
      rs485-rts-active-high;
      rs485-rts-delay = <0 0>;
      rts-gpios = <&gpio2 12 0>;
    };
  };
};
```

## Что видно на анализаторе

### Временные диаграммы:
```
RTS     : __/‾‾‾‾‾‾‾‾‾‾‾‾‾\______________
TX_Host : __/データデータデータ\______________ 
RX_Dev  : __/データデータデータ\______________
TX_Dev  : ___________________/レスポンス\__
RX_Host : ___________________/レスポンス\__
```

### Типичные временные параметры:
- **RTS → TX задержка**: 0-50 мкс
- **TX → RTS задержка**: 0-50 мкс  
- **Turnaround время**: 1-10 мс между запросом и ответом

## Параметры анализа

### Настройки анализатора:
- **Частота дискретизации**: минимум 10x скорости UART
- **Буфер**: достаточный для захвата всей транзакции  
- **Триггер**: по фронту RTS или началу передачи

### Декодер протокола:
```
# Настройки UART декодера
Baudrate: 9600
Data bits: 8
Parity: None  
Stop bits: 1
```

## Диагностика проблем

### Типичные проблемы на диаграммах:

**1. Коллизии данных:**
```
TX_Host : /データ\
TX_Dev  : /データ\  ← одновременная передача
```

**2. Неправильные задержки RTS:**
```  
RTS     : /‾‾‾\        ← слишком короткий импульс
TX_Host :    /データ\  ← данные обрезаются
```

**3. Отсутствие ответа:**
```
TX_Host : /データ\____________
TX_Dev  : __________________  ← нет ответа от датчика
```

## Программное тестирование

### Команды для генерации трафика:
```bash
# Отправка Modbus запроса (чтение регистра)
echo -ne "\x01\x03\x00\x00\x00\x01\x84\x0A" > /dev/ttyS1

# Мониторинг ответа
hexdump -C < /dev/ttyS1
```

### Python скрипт для тестирования:
```python
import serial
import time

ser = serial.Serial('/dev/ttyS1', 9600, timeout=1)

# Modbus запрос: чтение 1 регистра с адреса 0
request = b'\x01\x03\x00\x00\x00\x01\x84\x0A'
ser.write(request)
time.sleep(0.1)
response = ser.read(16)
print(f"Response: {response.hex()}")
```

Анализ сигналов на анализаторе позволяет точно диагностировать проблемы синхронизации, коллизии и таймингов в RS485 сетях.